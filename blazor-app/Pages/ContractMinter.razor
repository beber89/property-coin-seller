@page "/minter"
@using Nethereum.Web3;
@using Newtonsoft.Json.Linq;
@using Microsoft.JSInterop;

@inject HttpClient Http;
@inject Web3Service Web3s;
@inject IJSRuntime JSRuntime;

<h1>Minter</h1>

<input @bind="proofFile" type="file" placeholder="Add Solution"/>
<button class="btn btn-primary" @onclick="SubmitProof">Submit Proof</button>
<br>
<br>
<input @bind="proofKey" type="text" placeholder="Add Key"/>
<button class="btn btn-primary" @onclick="Mint">Mint</button>
<br>
<br>
<span>@status</span>

@code {
  protected override async Task OnInitializedAsync()  {
    await JSRuntime.InvokeVoidAsync("App.onload");
    @* await JSRuntime.InvokeAsync<dynamic>("getEthereum"); *@
    @* Web3s.Callback(ethProvider); *@
    @* await GetAccountBalance(); *@
  }
  private string proofFile;
  private string proofKey;
  private string status;
    private async void SubmitProof()
    {
      this.status = "adding proof ... ";
      this.StateHasChanged();
      string[] path = proofFile.Split("\\", 10);
      ProofModel soln = await Http.GetFromJsonAsync<ProofModel>($"proofs/{path[2]}");
      string key = await JSRuntime.InvokeAsync<string>("App.addSolution", soln);
        Console.WriteLine("key is "+key);
      if (key == "-1") {
        this.status = "Event is not caught,\n Please find the key in etherscan emitted by SolutionAdded Event\nPaste it in input field before minting";
      } else {
        this.status = "Solution added, hash key is " + key + " \nCopy it in the minting section to mint this new token";
      }
      this.StateHasChanged();
    }

    private async void Mint() {
      proofKey = proofKey.Substring(0, 2) == "0x"? proofKey: ("0x"+proofKey);
      await JSRuntime.InvokeVoidAsync("App.setProofKey", proofKey);
      await JSRuntime.InvokeVoidAsync("App.mint");
    }
    public class ProofModel
    {
        public Proof proof { get; set; }

        public List<string> inputs  { get; set; }
    }
    public class Proof {
      public List<string> a { get; set; }
      public List<List<string>> b { get; set; }
      public List<string> c { get; set; }
    }
}
